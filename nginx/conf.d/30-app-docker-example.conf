# =============================================================================
# ПРИМЕР: Приложение в Docker-контейнере
# =============================================================================
# Скопируйте этот файл и настройте для вашего приложения.
# 
# Шаги подключения:
# 1. Добавьте upstream в 00-upstream.conf
# 2. Скопируйте этот файл: cp 30-app-docker-example.conf 30-myapp.conf
# 3. Настройте server_name и proxy_pass
# 4. Подключите контейнер к сети iam-network
# =============================================================================

server {
    listen 80;
    listen [::]:80;
    
    # Домен приложения
    server_name app1.localhost;
    
    # Логирование с информацией об аутентификации
    access_log /var/log/nginx/app1-access.log auth;
    error_log /var/log/nginx/app1-error.log warn;
    
    # -------------------------------------------------------------------------
    # OAuth2-Proxy endpoints (обязательно)
    # -------------------------------------------------------------------------
    include /etc/nginx/snippets/oauth2-proxy.conf;
    
    # -------------------------------------------------------------------------
    # Главный location - защищен аутентификацией
    # -------------------------------------------------------------------------
    location / {
        # Включение аутентификации одной строкой
        include /etc/nginx/snippets/auth.conf;
        
        # Проверка группы (раскомментируйте для RBAC)
        # if ($auth_groups !~ "app1-users|admins") {
        #     return 403;
        # }
        
        # Проксирование к приложению
        proxy_pass http://demo-app1;
        
        # Стандартные параметры проксирования
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # -------------------------------------------------------------------------
    # API endpoint (пример с проверкой роли)
    # -------------------------------------------------------------------------
    location /api/ {
        include /etc/nginx/snippets/auth.conf;
        
        # Доступ только для группы api-users или admins
        # if ($auth_groups !~ "api-users|admins") {
        #     return 403;
        # }
        
        proxy_pass http://demo-app1/api/;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # -------------------------------------------------------------------------
    # Публичные ресурсы (без аутентификации)
    # -------------------------------------------------------------------------
    location /public/ {
        proxy_pass http://demo-app1/public/;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # -------------------------------------------------------------------------
    # Health check (без аутентификации)
    # -------------------------------------------------------------------------
    location /health {
        proxy_pass http://demo-app1/health;
        include /etc/nginx/snippets/proxy-params.conf;
        access_log off;
    }
}
