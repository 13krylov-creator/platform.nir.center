# =============================================================================
# Основной виртуальный хост IAM Platform
# =============================================================================
# Обрабатывает запросы к основному домену и служит порталом платформы.
# =============================================================================

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    # Основной домен (задается через переменную или localhost по умолчанию)
    server_name localhost _;
    
    # Корневая директория для статических файлов
    root /usr/share/nginx/html;
    index index.html;
    
    # Логирование
    access_log /var/log/nginx/platform-access.log main;
    error_log /var/log/nginx/platform-error.log warn;
    
    # -------------------------------------------------------------------------
    # OAuth2-Proxy endpoints (обязательно для всех server-блоков)
    # -------------------------------------------------------------------------
    include /etc/nginx/snippets/oauth2-proxy.conf;
    
    # -------------------------------------------------------------------------
    # Главная страница - портал платформы с SSI
    # -------------------------------------------------------------------------
    location / {
        # Защита аутентификацией
        auth_request /oauth2/auth;
        error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;
        
        # Получаем данные от OAuth2-Proxy
        auth_request_set $auth_user $upstream_http_x_auth_request_user;
        auth_request_set $auth_email $upstream_http_x_auth_request_email;
        auth_request_set $auth_groups $upstream_http_x_auth_request_groups;
        auth_request_set $auth_preferred_username $upstream_http_x_auth_request_preferred_username;
        
        # Включаем SSI для index.html
        ssi on;
        
        # Устанавливаем SSI переменные
        set $ssi_user $auth_user;
        set $ssi_email $auth_email;
        set $ssi_groups $auth_groups;
        set $ssi_username $auth_preferred_username;
        
        # Статические файлы
        try_files $uri $uri/ /index.html;
    }
    
    # -------------------------------------------------------------------------
    # Демо-приложение 1 (проксирование с аутентификацией)
    # -------------------------------------------------------------------------
    location /app1/ {
        # Аутентификация
        auth_request /oauth2/auth;
        error_page 401 = /oauth2/start?rd=$scheme://$http_host$request_uri;
        
        # Получаем группы
        auth_request_set $auth_groups_app1 $upstream_http_x_auth_request_groups;
        
        proxy_pass http://demo-app1/;
        include /etc/nginx/snippets/proxy-params.conf;
    }

    # -------------------------------------------------------------------------
    # Keycloak Admin Console (только для админов)
    # -------------------------------------------------------------------------
    location /keycloak-admin/ {
        # Аутентификация  
        auth_request /oauth2/auth;
        error_page 401 = /oauth2/start?rd=$scheme://$http_host$request_uri;
        
        # Редирект на Keycloak
        return 302 $scheme://$host:5058/admin/platform/console/;
    }
    
    # -------------------------------------------------------------------------
    # App Manager API (только для админов)
    # -------------------------------------------------------------------------
    location /api/ {
        # Аутентификация
        auth_request /oauth2/auth;
        error_page 401 = /oauth2/start?rd=$scheme://$http_host$request_uri;
        
        # Получаем данные пользователя для передачи в API
        auth_request_set $auth_user_api $upstream_http_x_auth_request_user;
        auth_request_set $auth_email_api $upstream_http_x_auth_request_email;
        auth_request_set $auth_groups_api $upstream_http_x_auth_request_groups;
        
        # Передаем заголовки в app-manager для проверки прав
        proxy_set_header X-Auth-User $auth_user_api;
        proxy_set_header X-Auth-Email $auth_email_api;
        proxy_set_header X-Auth-Groups $auth_groups_api;
        
        proxy_pass http://app-manager:8000;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # -------------------------------------------------------------------------
    # Страница здоровья (без аутентификации)
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }
    
    # -------------------------------------------------------------------------
    # Статические ресурсы (кэширование)
    # -------------------------------------------------------------------------
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # -------------------------------------------------------------------------
    # Запрет доступа к скрытым файлам
    # -------------------------------------------------------------------------
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# =============================================================================
# HTTPS сервер (раскомментировать для production)
# =============================================================================
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name localhost;
#     
#     # SSL сертификаты
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     
#     # SSL параметры
#     include /etc/nginx/snippets/ssl-params.conf;
#     
#     # Остальная конфигурация аналогична HTTP серверу
#     root /usr/share/nginx/html;
#     index index.html;
#     
#     include /etc/nginx/conf.d/01-oauth2-proxy.conf;
#     
#     location / {
#         include /etc/nginx/snippets/auth.conf;
#         try_files $uri $uri/ /index.html;
#     }
# }

# =============================================================================
# Редирект HTTP -> HTTPS (раскомментировать для production)
# =============================================================================
# server {
#     listen 80;
#     listen [::]:80;
#     server_name localhost;
#     return 301 https://$server_name$request_uri;
# }
