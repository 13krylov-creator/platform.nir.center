# =============================================================================
# OAuth2-Proxy endpoints
# =============================================================================
# Этот блок обрабатывает все запросы аутентификации.
# Включается в каждый server-блок через include.
# =============================================================================

# -----------------------------------------------------------------------------
# Внутренний endpoint для auth_request
# -----------------------------------------------------------------------------
location = /oauth2/auth {
    internal;
    
    proxy_pass http://oauth2-proxy/oauth2/auth;
    
    # Используем http_host для передачи порта
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Uri $request_uri;
    
    # Не передавать тело запроса
    proxy_set_header Content-Length "";
    proxy_pass_request_body off;
    
    # Увеличенные буферы для токенов
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
}

# -----------------------------------------------------------------------------
# Начало процесса аутентификации
# -----------------------------------------------------------------------------
location /oauth2/start {
    proxy_pass http://oauth2-proxy/oauth2/start;
    
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Auth-Request-Redirect $arg_rd;
}

# -----------------------------------------------------------------------------
# Callback после аутентификации в Keycloak
# -----------------------------------------------------------------------------
location /oauth2/callback {
    proxy_pass http://oauth2-proxy/oauth2/callback;
    
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    
    # Буферы для токенов
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
}

# -----------------------------------------------------------------------------
# Выход из системы
# -----------------------------------------------------------------------------
location /oauth2/sign_out {
    proxy_pass http://oauth2-proxy/oauth2/sign_out;
    
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
}

# -----------------------------------------------------------------------------
# Информация о пользователе
# -----------------------------------------------------------------------------
location /oauth2/userinfo {
    proxy_pass http://oauth2-proxy/oauth2/userinfo;
    
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
}
