# =============================================================================
# Сниппет аутентификации через OAuth2-Proxy
# =============================================================================
# Использование: include /etc/nginx/snippets/auth.conf;
# 
# Этот сниппет добавляет защиту аутентификации к location-блоку.
# OAuth2-Proxy проверяет сессию пользователя и возвращает:
# - 202: Пользователь аутентифицирован
# - 401: Требуется аутентификация (редирект на логин)
# =============================================================================

# Запрос к OAuth2-Proxy для проверки аутентификации
auth_request /oauth2/auth;

# Установка переменных из ответа OAuth2-Proxy
auth_request_set $auth_user $upstream_http_x_auth_request_user;
auth_request_set $auth_email $upstream_http_x_auth_request_email;
auth_request_set $auth_groups $upstream_http_x_auth_request_groups;
auth_request_set $auth_access_token $upstream_http_x_auth_request_access_token;

# Передача информации о пользователе в upstream
proxy_set_header X-Auth-Request-User $auth_user;
proxy_set_header X-Auth-Request-Email $auth_email;
proxy_set_header X-Auth-Request-Groups $auth_groups;
proxy_set_header X-Auth-Request-Access-Token $auth_access_token;

# Обработка ошибки 401 - редирект на страницу входа
# rd содержит полный URL для возврата после аутентификации
error_page 401 = /oauth2/start?rd=$scheme://$http_host$request_uri;
